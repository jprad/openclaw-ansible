---
- name: Create clawdbot system user
  ansible.builtin.user:
    name: "{{ clawdbot_user }}"
    comment: "Clawdbot Service User"
    system: true
    shell: /bin/bash
    create_home: true
    home: "{{ clawdbot_home }}"
    state: present

- name: Add clawdbot user to sudoers with scoped NOPASSWD
  ansible.builtin.copy:
    dest: /etc/sudoers.d/clawdbot
    mode: '0440'
    owner: root
    group: root
    content: |
      # Clawdbot sudo permissions (scoped for security)
      #
      # SECURITY NOTE: These permissions are intentionally limited.
      # If clawdbot is compromised, attackers can only:
      # - Manage the clawdbot service
      # - Run basic tailscale diagnostics
      # - View clawdbot logs
      #
      # To grant full tailscale control (e.g., for self-healing VPN):
      #   clawdbot ALL=(ALL) NOPASSWD: /usr/bin/tailscale *
      #
      # To grant full sudo (NOT RECOMMENDED):
      #   clawdbot ALL=(ALL) NOPASSWD: ALL

      # Service control - clawdbot service only
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl start clawdbot
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop clawdbot
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart clawdbot
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl status clawdbot
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl enable clawdbot
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl disable clawdbot
      # daemon-reload affects all units (required after service file changes)
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl daemon-reload

      # Tailscale - diagnostics + connect/disconnect
      # NOTE: 'up' allows flags like --advertise-exit-node. For tighter control,
      # remove 'up' and 'down' lines - operator must then manage VPN manually.
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale status
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale up *
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale down
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale ip *
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale version
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale ping *
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/tailscale whois *

      # Journal access - clawdbot logs only
      {{ clawdbot_user }} ALL=(ALL) NOPASSWD: /usr/bin/journalctl -u clawdbot *
    validate: /usr/sbin/visudo -cf %s

# Fix DBus issues for systemd user services
- name: Get clawdbot user ID
  ansible.builtin.command: id -u {{ clawdbot_user }}
  register: clawdbot_uid
  changed_when: false
  when: ansible_os_family == 'Debian'

- name: Display clawdbot user ID
  ansible.builtin.debug:
    msg: "Clawdbot user ID: {{ clawdbot_uid.stdout }}"
  when: ansible_os_family == 'Debian'

- name: Enable lingering for clawdbot user (allows systemd user services without login)
  ansible.builtin.command: loginctl enable-linger {{ clawdbot_user }}
  changed_when: false
  when: ansible_os_family == 'Debian'

- name: Create runtime directory for clawdbot user
  ansible.builtin.file:
    path: "/run/user/{{ clawdbot_uid.stdout }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0700'
  when: ansible_os_family == 'Debian'

- name: Store clawdbot UID as fact for later use
  ansible.builtin.set_fact:
    clawdbot_uid_value: "{{ clawdbot_uid.stdout }}"
  when: ansible_os_family == 'Debian'

- name: Verify clawdbot UID was successfully retrieved
  ansible.builtin.assert:
    that:
      - clawdbot_uid_value is defined
      - clawdbot_uid_value | length > 0
    fail_msg: "Failed to retrieve clawdbot user UID. Cannot continue with systemd service setup."
    success_msg: "Clawdbot UID verified: {{ clawdbot_uid_value }}"
  when: ansible_os_family == 'Debian'

# SSH key configuration
- name: Create .ssh directory for clawdbot user
  ansible.builtin.file:
    path: "{{ clawdbot_home }}/.ssh"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0700'

- name: Add SSH authorized keys for clawdbot user
  ansible.builtin.authorized_key:
    user: "{{ clawdbot_user }}"
    state: present
    key: "{{ item }}"
  loop: "{{ clawdbot_ssh_keys }}"
  when: clawdbot_ssh_keys | length > 0
  no_log: true

- name: Display SSH key configuration status
  ansible.builtin.debug:
    msg: "✅ {{ clawdbot_ssh_keys | length }} SSH key(s) configured for clawdbot user"
  when: clawdbot_ssh_keys | length > 0

- name: Display SSH key warning if none configured
  ansible.builtin.debug:
    msg: "⚠️  No SSH keys configured. Set 'clawdbot_ssh_keys' variable to allow SSH access."
  when: clawdbot_ssh_keys | length == 0

- name: Set XDG_RUNTIME_DIR in .bashrc for clawdbot user
  ansible.builtin.lineinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    line: 'export XDG_RUNTIME_DIR=/run/user/$(id -u)'
    state: present
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_os_family == 'Debian'

- name: Set DBUS_SESSION_BUS_ADDRESS in .bashrc for clawdbot user
  ansible.builtin.blockinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DBus config"
    block: |
      # DBus session bus configuration
      if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
        if [ -f "${XDG_RUNTIME_DIR}/bus" ]; then
          export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
        fi
      fi
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
  when: ansible_os_family == 'Debian'
