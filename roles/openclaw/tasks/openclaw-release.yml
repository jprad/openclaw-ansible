---
# Release mode installation - Install via pnpm from npm registry

- name: Install OpenClaw globally as clawdbot user (using pnpm)
  ansible.builtin.shell:
    cmd: pnpm install -g clawdbot@latest
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: clawdbot_install
  changed_when: "'Already up to date' not in clawdbot_install.stdout"

- name: Verify clawdbot installation
  ansible.builtin.shell:
    cmd: clawdbot --version
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ clawdbot_home }}/.local/share/pnpm:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ clawdbot_home }}"
  register: clawdbot_version
  changed_when: false

- name: Display installed OpenClaw version (release)
  ansible.builtin.debug:
    msg: "âœ… OpenClaw installed from npm: {{ clawdbot_version.stdout }}"
